name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Validate knowledge base JSON
        run: |
          echo "Validating JSON files..."
          for file in knowledge/*.json; do
            echo "  Checking $file..."
            node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))"
          done
          echo "âœ… All knowledge files are valid JSON"

      - name: ğŸ§ª Test ESM imports
        run: |
          node --input-type=module -e "
          import SearchEngine from './src/core/SearchEngine.js';
          import KnowledgeManager from './src/core/KnowledgeManager.js';
          console.log('âœ… Core modules import successfully');
          "

      - name: ğŸ” Test search functionality
        run: |
          node --input-type=module -e "
          import SearchEngine from './src/core/SearchEngine.js';
          import KnowledgeManager from './src/core/KnowledgeManager.js';
          
          const km = new KnowledgeManager('./knowledge');
          await km.load();
          
          const engine = new SearchEngine();
          engine.indexKnowledgeBase(km.knowledgeBase);
          
          // Test basic search
          const results = engine.search('microflow');
          console.log('ğŸ” Search test: microflow â†’ ' + results.length + ' results');
          
          // Test fuzzy search
          const fuzzyResults = engine.search('micorflow');
          console.log('ğŸ” Fuzzy test: micorflow â†’ ' + fuzzyResults.length + ' results');
          
          if (results.length === 0) {
            console.error('âŒ Search test failed - no results for microflow!');
            process.exit(1);
          }
          
          console.log('âœ… Search tests passed!');
          "

      - name: âœ… Syntax check main server
        run: node --check src/index.js

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“ Check JSON validity
        run: |
          for file in knowledge/*.json config/*.json; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))"
            fi
          done
          echo "âœ… All JSON files are valid"

      - name: ğŸ“ Check package.json
        run: |
          node -e "
          const pkg = require('./package.json');
          console.log('ğŸ“¦ Package:', pkg.name, 'v' + pkg.version);
          console.log('âœ… package.json is valid');
          "
